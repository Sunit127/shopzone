<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopZone - Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #0f0f1a; color: #fff; }
        nav { background: linear-gradient(135deg, #6c00ff, #ff006e); padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; }
        nav .logo { font-size: 24px; font-weight: bold; }
        nav a { color: #fff; text-decoration: none; margin-left: 12px; padding: 7px 15px; border-radius: 25px; font-size: 14px; }
        nav a:hover { background: rgba(255,255,255,0.2); }
        .wrap { padding: 30px 40px; }
        .stats-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #1e1e3a, #2a1a4a); border: 1px solid #6c00ff44; border-radius: 14px; padding: 25px; text-align: center; }
        .stat-card .num { font-size: 36px; font-weight: bold; background: linear-gradient(135deg, #6c00ff, #ff006e); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-card p { color: #aaa; font-size: 14px; margin-top: 5px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        .tab { padding: 10px 25px; border-radius: 25px; border: 1px solid #6c00ff; background: transparent; color: #6c00ff; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .tab.active { background: linear-gradient(135deg, #6c00ff, #ff006e); color: #fff; border-color: transparent; }
        .section { display: none; }
        .section.active { display: block; }
        .card { background: linear-gradient(135deg, #1e1e3a, #2a1a4a); border: 1px solid #6c00ff44; border-radius: 16px; padding: 25px; margin-bottom: 20px; }
        .card h3 { color: #ff9500; margin-bottom: 20px; font-size: 18px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #6c00ff22; padding: 12px; text-align: left; font-size: 13px; color: #aaa; border-bottom: 1px solid #6c00ff22; }
        td { padding: 12px; font-size: 14px; border-bottom: 1px solid #6c00ff11; }
        tr:hover td { background: #6c00ff11; }
        .product-img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; }
        .status-select { background: #0f0f1a; border: 1px solid #6c00ff44; color: #fff; padding: 5px 10px; border-radius: 8px; font-size: 13px; cursor: pointer; }
        .edit-btn { background: #6c00ff22; border: 1px solid #6c00ff44; color: #6c00ff; padding: 6px 14px; border-radius: 8px; cursor: pointer; font-size: 12px; margin-right: 5px; }
        .edit-btn:hover { background: #6c00ff44; }
        .del-btn { background: #ff006e22; border: 1px solid #ff006e44; color: #ff006e; padding: 6px 14px; border-radius: 8px; cursor: pointer; font-size: 12px; }
        .del-btn:hover { background: #ff006e44; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group label { display: block; color: #aaa; margin-bottom: 6px; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 14px; background: #0f0f1a; border: 1px solid #6c00ff44; border-radius: 8px; color: #fff; font-size: 14px; outline: none; }
        .form-group textarea { min-height: 70px; resize: vertical; }
        .add-btn { padding: 12px 28px; background: linear-gradient(135deg, #6c00ff, #ff006e); border: none; border-radius: 10px; color: #fff; font-size: 15px; font-weight: bold; cursor: pointer; }
        .badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; }
        .badge.Pending { background: #ff950022; color: #ff9500; }
        .badge.Processing { background: #6c00ff22; color: #a855f7; }
        .badge.Shipped { background: #00c89622; color: #00c896; }
        .badge.Delivered { background: #00ff6422; color: #00ff64; }
        .badge.Cancelled { background: #ff006e22; color: #ff006e; }
        .revenue { font-size: 28px; font-weight: bold; color: #00ff64; text-align: center; padding: 15px; }
        .image-upload-box { border: 2px dashed #6c00ff44; border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: border 0.3s, background 0.3s; margin-bottom: 10px; min-height: 120px; display: flex; align-items: center; justify-content: center; }
        .image-upload-box:hover { border-color: #6c00ff; background: #6c00ff11; }
        .image-preview { max-width: 200px; max-height: 150px; border-radius: 8px; margin-top: 10px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: linear-gradient(135deg, #1e1e3a, #2a1a4a); border: 1px solid #6c00ff44; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-close { float: right; cursor: pointer; font-size: 24px; color: #aaa; }
        .modal-close:hover { color: #fff; }
    </style>
</head>
<body>
<nav>
    <div class="logo">üõçÔ∏è ShopZone ‚Äî Admin</div>
    <div><a href="/">Home</a><a href="/shop">Shop</a><a href="#" onclick="logout()">Logout</a></div>
</nav>
<div class="wrap">
    <div class="stats-row" id="statsRow"></div>
    <div class="tabs">
        <button class="tab active" onclick="showTab('products', this)">üõçÔ∏è Products</button>
        <button class="tab" onclick="showTab('orders', this)">üì¶ Orders</button>
        <button class="tab" onclick="showTab('users', this)">üë• Users</button>
    </div>

    <!-- PRODUCTS SECTION -->
    <div class="section active" id="tab-products">
        <div class="card">
            <h3>‚ûï Add New Product</h3>
            <div class="form-row">
                <div class="form-group"><label>Product Name</label><input id="pName" placeholder="Name" /></div>
                <div class="form-group"><label>Price ($)</label><input id="pPrice" type="number" placeholder="Price" /></div>
                <div class="form-group"><label>Category</label>
                    <select id="pCategory">
                        <option>Shoes</option>
                        <option>Clothing</option>
                        <option>Electronics</option>
                        <option>Accessories</option>
                    </select>
                </div>
            </div>
            <div class="form-group"><label>Description</label><textarea id="pDesc" placeholder="Product description"></textarea></div>
            
            <div class="form-group">
                <label>Product Image (Upload or URL)</label>
                <div class="image-upload-box" id="imageUploadBox" onclick="document.getElementById('pImageFile').click()">
                    <div id="uploadPlaceholder" style="text-align: center;">
                        <div style="font-size:40px;margin-bottom:10px">üì∏</div>
                        <div style="color:#aaa">Click to upload image OR paste URL below</div>
                    </div>
                    <img id="imagePreview" class="image-preview" style="display:none;" />
                </div>
                <input type="file" id="pImageFile" accept="image/*" style="display:none" onchange="handleImageUpload(event)" />
                <input type="text" id="pImageUrl" placeholder="Or paste image URL here (e.g., https://example.com/image.jpg)" style="width:100%;padding:10px 14px;background:#0f0f1a;border:1px solid #6c00ff44;border-radius:8px;color:#fff;font-size:14px;outline:none;margin-top:10px;" />
            </div>

            <button class="add-btn" onclick="addProduct()">‚ûï Add Product</button>
            <div id="addMsg" style="margin-top:12px;padding:10px;border-radius:8px;display:none;text-align:center;font-size:14px;"></div>
        </div>

        <div class="card">
            <h3>üõçÔ∏è All Products</h3>
            <table>
                <thead><tr><th>Image</th><th>Name</th><th>Category</th><th>Price</th><th>Rating</th><th>Actions</th></tr></thead>
                <tbody id="productsTable"></tbody>
            </table>
        </div>
    </div>

    <!-- ORDERS SECTION -->
    <div class="section" id="tab-orders">
        <div class="card">
            <h3>üì¶ All Orders</h3>
            <div class="revenue" id="totalRevenue"></div>
            <table>
                <thead><tr><th>ID</th><th>Customer</th><th>Items</th><th>Total</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="ordersTable"></tbody>
            </table>
        </div>
    </div>

    <!-- USERS SECTION -->
    <div class="section" id="tab-users">
        <div class="card">
            <h3>üë• All Users</h3>
            <table>
                <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Joined</th><th>Actions</th></tr></thead>
                <tbody id="usersTable"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- EDIT PRODUCT MODAL -->
<div class="modal" id="editProductModal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('editProductModal')">&times;</span>
        <h3 style="color:#ff9500;margin-bottom:20px">‚úèÔ∏è Edit Product</h3>
        <div class="form-group"><label>Product Name</label><input id="editPName" placeholder="Name" /></div>
        <div class="form-group"><label>Price ($)</label><input id="editPPrice" type="number" placeholder="Price" /></div>
        <div class="form-group"><label>Category</label>
            <select id="editPCategory">
                <option>Shoes</option>
                <option>Clothing</option>
                <option>Electronics</option>
                <option>Accessories</option>
            </select>
        </div>
        <div class="form-group"><label>Description</label><textarea id="editPDesc" placeholder="Product description"></textarea></div>
        <button class="add-btn" onclick="saveEditProduct()" style="width:100%;margin-top:15px">üíæ Save Changes</button>
    </div>
</div>

<script>
    const user = JSON.parse(localStorage.getItem("shopUser"))
    if (!user) { window.location.href = "/login" }

    let editingProductId = null
    let selectedImageFile = null

    function handleImageUpload(e) {
        const file = e.target.files[0]
        if (!file) return
        selectedImageFile = file
        const reader = new FileReader()
        reader.onload = (ev) => {
            document.getElementById("imagePreview").src = ev.target.result
            document.getElementById("imagePreview").style.display = "block"
            document.getElementById("uploadPlaceholder").style.display = "none"
            document.getElementById("pImageUrl").value = "" // Clear URL input if file is selected
        }
        reader.readAsDataURL(file)
    }

    async function loadAll() {
        try {
            const [pRes, oRes, uRes] = await Promise.all([
                fetch("/api/products"), 
                fetch("/api/orders/all"), 
                fetch("/api/users")
            ])
            const [pData, oData, uData] = await Promise.all([
                pRes.json(), 
                oRes.json(), 
                uRes.json()
            ])

            const products = pData.products || [], orders = oData.orders || [], users = uData.users || []
            const revenue = orders.reduce((s, o) => s + parseFloat(o.total), 0)

            // Stats
            document.getElementById("statsRow").innerHTML = `
                <div class="stat-card"><div class="num">${products.length}</div><p>Total Products</p></div>
                <div class="stat-card"><div class="num">${orders.length}</div><p>Total Orders</p></div>
                <div class="stat-card"><div class="num">${users.length}</div><p>Total Users</p></div>
                <div class="stat-card"><div class="num">$${revenue.toFixed(0)}</div><p>Total Revenue</p></div>`

            document.getElementById("totalRevenue").textContent = `üí∞ Total Revenue: $${revenue.toFixed(2)}`

            // Products Table
            document.getElementById("productsTable").innerHTML = products.map(p => `
                <tr>
                    <td><img src="${p.image}" alt="${p.name}" class="product-img" onerror="this.src='https://via.placeholder.com/50?text=No+Image'" /></td>
                    <td>${p.name}</td>
                    <td>${p.category}</td>
                    <td>$${p.price}</td>
                    <td>‚≠ê${p.rating || 0}</td>
                    <td>
                        <button class="edit-btn" onclick="openEditProduct(${p.id}, '${p.name.replace(/'/g, "\\'")}', ${p.price}, '${p.category}', '${(p.description || '').replace(/'/g, "\\'")}')">‚úèÔ∏è Edit</button>
                        <button class="del-btn" onclick="deleteProduct(${p.id})">üóë Delete</button>
                    </td>
                </tr>`).join("") || "<tr><td colspan='6' style='text-align:center;color:#aaa'>No products yet</td></tr>"

            // Orders Table
            document.getElementById("ordersTable").innerHTML = orders.reverse().map(o => `
                <tr>
                    <td>#${o.id}</td>
                    <td>${o.userName}</td>
                    <td>${o.items.map(i => `${i.name} (x${i.qty})`).join(", ")}</td>
                    <td>$${parseFloat(o.total).toFixed(2)}</td>
                    <td>${o.date}</td>
                    <td>
                        <select class="status-select" onchange="updateStatus(${o.id}, this.value)">
                            ${["Pending","Processing","Shipped","Delivered","Cancelled"].map(s => `<option ${s === o.status ? "selected" : ""}>${s}</option>`).join("")}
                        </select>
                    </td>
                    <td>
                        <button class="del-btn" onclick="deleteOrder(${o.id})">üóë Delete</button>
                    </td>
                </tr>`).join("") || "<tr><td colspan='7' style='text-align:center;color:#aaa'>No orders yet</td></tr>"

            // Users Table
            document.getElementById("usersTable").innerHTML = users.map(u => `
                <tr>
                    <td>#${u.id}</td>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td>${u.createdAt ? u.createdAt.split("T")[0] : "N/A"}</td>
                    <td>
                        <button class="del-btn" onclick="deleteUser(${u.id})">üóë Delete</button>
                    </td>
                </tr>`).join("") || "<tr><td colspan='5' style='text-align:center;color:#aaa'>No users yet</td></tr>"
        } catch (err) {
            console.error("Error loading data:", err)
            alert("Error loading data. Check console.")
        }
    }

    async function addProduct() {
        const name = document.getElementById("pName").value.trim()
        const price = document.getElementById("pPrice").value
        const category = document.getElementById("pCategory").value
        const description = document.getElementById("pDesc").value.trim()
        const imageUrl = document.getElementById("pImageUrl").value.trim()
        const msgEl = document.getElementById("addMsg")

        if (!name || !price || !category) {
            showMsg(msgEl, "‚ùå Name, price, and category are required!", "error")
            return
        }

        let res

        if (selectedImageFile) {
            // Upload file
            const formData = new FormData()
            formData.append("name", name)
            formData.append("price", price)
            formData.append("category", category)
            formData.append("description", description)
            formData.append("image", selectedImageFile)

            res = await fetch("/api/products/add", {
                method: "POST",
                body: formData
            })
        } else if (imageUrl) {
            // Use URL
            res = await fetch("/api/products/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, price, category, description, image: imageUrl })
            })
        } else {
            // No image - use placeholder
            res = await fetch("/api/products/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, price, category, description, image: "" })
            })
        }

        const data = await res.json()
        if (data.success) {
            showMsg(msgEl, "‚úÖ Product added successfully!", "success")
            // Reset form
            document.getElementById("pName").value = ""
            document.getElementById("pPrice").value = ""
            document.getElementById("pDesc").value = ""
            document.getElementById("pImageUrl").value = ""
            document.getElementById("pImageFile").value = ""
            document.getElementById("imagePreview").style.display = "none"
            document.getElementById("uploadPlaceholder").style.display = "block"
            selectedImageFile = null
            setTimeout(() => loadAll(), 500)
        } else {
            showMsg(msgEl, "‚ùå " + (data.message || "Error adding product"), "error")
        }
        setTimeout(() => msgEl.style.display = "none", 4000)
    }

    function openEditProduct(id, name, price, category, description) {
        editingProductId = id
        document.getElementById("editPName").value = name
        document.getElementById("editPPrice").value = price
        document.getElementById("editPCategory").value = category
        document.getElementById("editPDesc").value = description
        document.getElementById("editProductModal").classList.add("active")
    }

    async function saveEditProduct() {
        if (!editingProductId) return

        const name = document.getElementById("editPName").value.trim()
        const price = document.getElementById("editPPrice").value
        const category = document.getElementById("editPCategory").value
        const description = document.getElementById("editPDesc").value.trim()

        if (!name || !price) {
            alert("‚ùå Name and price are required!")
            return
        }

        const res = await fetch(`/api/products/edit/${editingProductId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, price, category, description })
        })

        const data = await res.json()
        if (data.success) {
            closeModal("editProductModal")
            loadAll()
        } else {
            alert("‚ùå Error updating product: " + (data.message || "Unknown error"))
        }
    }

    function showMsg(el, text, type) {
        el.textContent = text
        el.style.background = type === "success" ? "rgba(0,255,100,0.1)" : "rgba(255,0,100,0.1)"
        el.style.color = type === "success" ? "#00ff64" : "#ff006e"
        el.style.display = "block"
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove("active")
    }

    async function deleteProduct(id) {
        if (!confirm("üóëÔ∏è Are you sure you want to delete this product?")) return
        const res = await fetch(`/api/products/delete/${id}`, { method: "DELETE" })
        const data = await res.json()
        if (data.success) loadAll()
        else alert("‚ùå Error deleting product")
    }

    async function deleteOrder(id) {
        if (!confirm("üóëÔ∏è Are you sure you want to delete this order?")) return
        const res = await fetch(`/api/orders/delete/${id}`, { method: "DELETE" })
        const data = await res.json()
        if (data.success) loadAll()
        else alert("‚ùå Error deleting order")
    }

    async function deleteUser(id) {
        if (!confirm("üóëÔ∏è Are you sure you want to delete this user?")) return
        const res = await fetch(`/api/users/delete/${id}`, { method: "DELETE" })
        const data = await res.json()
        if (data.success) loadAll()
        else alert("‚ùå Error deleting user")
    }

    async function updateStatus(id, status) {
        const res = await fetch(`/api/orders/status/${id}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status })
        })
        const data = await res.json()
        if (data.success) loadAll()
    }

    function showTab(name, btn) {
        document.querySelectorAll(".section").forEach(s => s.classList.remove("active"))
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"))
        document.getElementById("tab-" + name).classList.add("active")
        btn.classList.add("active")
    }

    function logout() {
        localStorage.removeItem("shopUser")
        localStorage.removeItem("cart")
        window.location.href = "/"
    }

    loadAll()
</script>
</body>
</html>