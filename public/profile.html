<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopZone - Profile</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #0f0f1a; color: #fff; }
        body.light { background: #f5f5f5; color: #111; }
        nav { background: linear-gradient(135deg, #6c00ff, #ff006e); padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; }
        nav .logo { font-size: 24px; font-weight: bold; }
        nav a { color: #fff; text-decoration: none; margin-left: 12px; padding: 7px 15px; border-radius: 25px; font-size: 14px; }
        nav a:hover { background: rgba(255,255,255,0.2); }
        .wrap { max-width: 800px; margin: 40px auto; padding: 0 20px; }
        .profile-header { background: linear-gradient(135deg, #1e1e3a, #2a1a4a); border: 1px solid #6c00ff44; border-radius: 20px; padding: 40px; text-align: center; margin-bottom: 25px; }
        body.light .profile-header { background: #fff; border-color: #ddd; }
        .avatar { width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #6c00ff, #ff006e); display: flex; align-items: center; justify-content: center; font-size: 40px; margin: 0 auto 15px; cursor: pointer; overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .profile-header h2 { font-size: 26px; margin-bottom: 5px; }
        .profile-header p { color: #aaa; }
        .card { background: linear-gradient(135deg, #1e1e3a, #2a1a4a); border: 1px solid #6c00ff44; border-radius: 16px; padding: 30px; margin-bottom: 20px; }
        body.light .card { background: #fff; border-color: #ddd; }
        .card h3 { font-size: 18px; margin-bottom: 20px; color: #ff9500; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; color: #aaa; margin-bottom: 7px; font-size: 13px; }
        .form-group input { width: 100%; padding: 12px 16px; background: #0f0f1a; border: 1px solid #6c00ff44; border-radius: 10px; color: #fff; font-size: 15px; outline: none; transition: border 0.3s; }
        body.light .form-group input { background: #f5f5f5; color: #111; }
        .form-group input:focus { border-color: #6c00ff; }
        .save-btn { padding: 12px 30px; background: linear-gradient(135deg, #6c00ff, #ff006e); border: none; border-radius: 10px; color: #fff; font-size: 16px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        .save-btn:hover { opacity: 0.9; }
        .msg { margin-top: 12px; padding: 10px; border-radius: 8px; display: none; text-align: center; }
        .msg.success { background: rgba(0,255,100,0.1); color: #00ff64; }
        .msg.error { background: rgba(255,0,100,0.1); color: #ff006e; }
        .wishlist-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .wish-item { background: #0f0f1a; border-radius: 10px; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        body.light .wish-item { background: #f0f0f0; }
        .wish-item:hover { transform: scale(1.03); }
        .wish-item img { width: 100%; height: 100px; object-fit: cover; }
        .wish-item p { padding: 8px; font-size: 13px; }
    </style>
</head>
<body>
<nav>
    <div class="logo">üõçÔ∏è ShopZone</div>
    <div>
        <a href="/">Home</a>
        <a href="/shop">Shop</a>
        <a href="/orders">Orders</a>
        <a href="#" onclick="logout()">Logout</a>
    </div>
</nav>
<div class="wrap">
    <div class="profile-header">
        <div class="avatar" id="avatarEl" onclick="document.getElementById('avatarInput').click()">üë§</div>
        <input type="file" id="avatarInput" accept="image/*" style="display:none" onchange="uploadAvatar(event)" />
        <h2 id="profileName"></h2>
        <p id="profileEmail"></p>
        <p style="color:#6c00ff;font-size:13px;margin-top:5px">Click avatar to change photo</p>
    </div>
    <div class="card">
        <h3>‚úèÔ∏è Edit Profile</h3>
        <div class="form-group"><label>Full Name</label><input id="nameInput" /></div>
        <div class="form-group"><label>Email</label><input id="emailInput" type="email" /></div>
        <div class="form-group"><label>New Password (leave blank to keep)</label><input id="passInput" type="password" placeholder="New password" /></div>
        <button class="save-btn" onclick="saveProfile()">üíæ Save Changes</button>
        <div class="msg" id="msg"></div>
    </div>
    <div class="card">
        <h3>‚ù§Ô∏è My Wishlist</h3>
        <div class="wishlist-grid" id="wishlistGrid"><p style="color:#aaa">Loading...</p></div>
    </div>
</div>
<script>
    if (localStorage.getItem("theme") === "light") document.body.classList.add("light")
    const user = JSON.parse(localStorage.getItem("shopUser"))
    if (!user) { window.location.href = "/login"; }

    document.getElementById("profileName").textContent = user.name
    document.getElementById("profileEmail").textContent = user.email
    document.getElementById("nameInput").value = user.name
    document.getElementById("emailInput").value = user.email
    if (user.avatar) { document.getElementById("avatarEl").innerHTML = `<img src="${user.avatar}" />`; }

    async function saveProfile() {
        const name = document.getElementById("nameInput").value
        const email = document.getElementById("emailInput").value
        const password = document.getElementById("passInput").value
        const res = await fetch("/api/profile/update", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ userId: user.id, name, email, password: password || undefined }) })
        const data = await res.json()
        const msg = document.getElementById("msg")
        if (data.success) {
            localStorage.setItem("shopUser", JSON.stringify({ ...user, ...data.user }))
            document.getElementById("profileName").textContent = data.user.name
            msg.textContent = "‚úÖ Profile updated!"; msg.className = "msg success"; msg.style.display = "block"
        } else { msg.textContent = "‚ùå " + data.message; msg.className = "msg error"; msg.style.display = "block" }
        setTimeout(() => msg.style.display = "none", 3000)
    }

    function uploadAvatar(e) {
        const file = e.target.files[0]
        if (!file) return
        const reader = new FileReader()
        reader.onload = async (ev) => {
            const avatar = ev.target.result
            await fetch("/api/profile/update", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ userId: user.id, avatar }) })
            user.avatar = avatar
            localStorage.setItem("shopUser", JSON.stringify(user))
            document.getElementById("avatarEl").innerHTML = `<img src="${avatar}" />`
        }
        reader.readAsDataURL(file)
    }

    async function loadWishlist() {
        const res = await fetch("/api/products")
        const data = await res.json()
        const wishlist = user.wishlist || []
        const wished = data.products.filter(p => wishlist.includes(p.id))
        const el = document.getElementById("wishlistGrid")
        if (wished.length === 0) { el.innerHTML = '<p style="color:#aaa">No wishlist items yet. <a href="/shop" style="color:#6c00ff">Browse shop</a></p>'; return }
        el.innerHTML = wished.map(p => `<div class="wish-item" onclick="window.location.href='/product?id=${p.id}'"><img src="${p.image}" /><p>${p.name}<br><span style="color:#ff006e">$${p.price}</span></p></div>`).join("")
    }

    function logout() { localStorage.removeItem("shopUser"); localStorage.removeItem("cart"); window.location.href = "/" }
    loadWishlist()
</script>
</body>
</html>